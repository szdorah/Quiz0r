generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Quiz template - reusable for multiple game sessions
model Quiz {
  id          String        @id @default(cuid())
  title       String
  description String?
  theme       String?       // JSON string containing QuizTheme
  autoAdmit   Boolean       @default(true) // Auto-admit players by default

  // Power-up Configuration (default: all disabled)
  hintCount          Int @default(0)
  copyAnswerCount    Int @default(0)
  doublePointsCount  Int @default(0)

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  isActive    Boolean       @default(true)

  questions    Question[]
  gameSessions GameSession[]
}

// Individual question within a quiz
// questionType: "SINGLE_SELECT" | "MULTI_SELECT"
model Question {
  id           String   @id @default(cuid())
  quizId       String
  quiz         Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  questionText String
  imageUrl     String?
  hostNotes    String?
  questionType String   @default("SINGLE_SELECT")
  timeLimit    Int      @default(30)
  points       Int      @default(100)
  orderIndex   Int

  // Easter Egg Configuration
  easterEggEnabled          Boolean  @default(false)
  easterEggButtonText       String?
  easterEggUrl              String?
  easterEggDisablesScoring  Boolean  @default(false)

  // Power-up Configuration
  hint String?  // Required if quiz has hintCount > 0

  answers         Answer[]
  playerAnswers   PlayerAnswer[]
  easterEggClicks EasterEggClick[]
  powerUpUsages   PowerUpUsage[]
  translations    QuestionTranslation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([quizId])
}

// Answer option for a question
model Answer {
  id         String   @id @default(cuid())
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  answerText String
  imageUrl   String?
  isCorrect  Boolean  @default(false)
  orderIndex Int

  translations AnswerTranslation[]

  @@index([questionId])
}

// Active game session
// status: "WAITING" | "ACTIVE" | "QUESTION" | "REVEALING" | "SCOREBOARD" | "FINISHED"
model GameSession {
  id       String @id @default(cuid())
  gameCode String @unique
  quizId   String
  quiz     Quiz   @relation(fields: [quizId], references: [id])

  status               String    @default("WAITING")
  currentQuestionIndex Int       @default(-1)
  questionStartedAt    DateTime?
  autoAdmit            Boolean   @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  endedAt   DateTime?

  players      Player[]
  certificates Certificate[]

  @@index([gameCode])
  @@index([status])
}

// Player in a game session
model Player {
  id            String      @id @default(cuid())
  gameSessionId String
  gameSession   GameSession @relation(fields: [gameSessionId], references: [id], onDelete: Cascade)

  name         String
  socketId     String?
  avatarColor  String?
  avatarEmoji  String?
  languageCode String? @default("en")  // Player's selected language

  totalScore    Int @default(0)
  currentStreak Int @default(0)

  joinedAt        DateTime  @default(now())
  isActive        Boolean   @default(true)
  admissionStatus String    @default("admitted")
  removedAt       DateTime?

  answers         PlayerAnswer[]
  easterEggClicks EasterEggClick[]
  powerUpUsages   PowerUpUsage[]
  certificates    Certificate[]

  @@unique([gameSessionId, name])
  @@index([gameSessionId])
}

// Player's answer to a question
// selectedAnswerIds: JSON array of answer IDs e.g. ["id1", "id2"]
model PlayerAnswer {
  id         String   @id @default(cuid())
  playerId   String
  player     Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  selectedAnswerIds String
  isCorrect         Boolean
  timeToAnswer      Int
  pointsEarned      Int

  answeredAt DateTime @default(now())

  @@unique([playerId, questionId])
  @@index([playerId])
  @@index([questionId])
}

// Easter egg click tracking
model EasterEggClick {
  id         String   @id @default(cuid())
  playerId   String
  player     Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  clickedAt  DateTime @default(now())

  @@unique([playerId, questionId])
  @@index([playerId])
  @@index([questionId])
}

// Power-up usage tracking
model PowerUpUsage {
  id         String   @id @default(cuid())
  playerId   String
  player     Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  powerUpType      String   // "hint", "copy", "double"
  copiedPlayerId   String?  // Only for "copy" type
  usedAt           DateTime @default(now())

  @@unique([playerId, questionId, powerUpType]) // Prevent using same type twice per question
  @@index([playerId])
  @@index([questionId])
}

// Translation for question text, host notes, hint, and easter egg button text
model QuestionTranslation {
  id         String   @id @default(cuid())
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  languageCode        String  // ISO 639-1 code: 'es', 'fr', 'de', etc.
  questionText        String
  hostNotes           String?
  hint                String?
  easterEggButtonText String?

  isAutoTranslated Boolean  @default(true) // false if manually edited
  translatedAt     DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([questionId, languageCode])
  @@index([questionId])
  @@index([languageCode])
}

// Translation for answer text
model AnswerTranslation {
  id       String @id @default(cuid())
  answerId String
  answer   Answer @relation(fields: [answerId], references: [id], onDelete: Cascade)

  languageCode String // ISO 639-1 code
  answerText   String

  isAutoTranslated Boolean  @default(true) // false if manually edited
  translatedAt     DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([answerId, languageCode])
  @@index([answerId])
  @@index([languageCode])
}

// Certificate tracking for game completion
model Certificate {
  id            String      @id @default(cuid())
  gameSessionId String
  gameSession   GameSession @relation(fields: [gameSessionId], references: [id], onDelete: Cascade)

  type      String  // "host" | "player"
  playerId  String?
  player    Player? @relation(fields: [playerId], references: [id], onDelete: Cascade)

  filePath     String? // e.g., "/uploads/certificates/ABC123/host-certificate.jpg"
  status       String  @default("pending") // "pending" | "generating" | "completed" | "failed"
  errorMessage String?
  aiMessage    String? // Cached AI congratulations message for player certificates
  retryCount   Int     @default(0) // Track retry attempts

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@unique([gameSessionId, type, playerId])
  @@index([gameSessionId])
  @@index([status])
}

// App settings (key-value store)
model Setting {
  key   String @id
  value String
}
